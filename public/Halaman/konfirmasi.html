<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Konfirmasi Pembelian - Kids Worksheet Store</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f9fafb; color:#333; }
    .container { max-width:800px; margin-top:50px; background:#fff; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,.05); padding:30px; }
    .table th { background-color:#f3f4f6; }
    .note { background:#fff3cd; color:#856404; border:1px solid #ffeeba; padding:12px; border-radius:8px; margin-top:20px; }
    .btn-disabled { background:#ccc; color:#666; cursor:not-allowed; padding:6px 12px; border-radius:6px; text-decoration:none; display:inline-block; }
    .btn-download { background:#22c55e; color:#fff; padding:6px 12px; border-radius:6px; text-decoration:none; display:inline-block; }
    .btn-download:hover { background:#16a34a; color:#fff; }
  </style>
</head>
<body>
  <div class="container">
    <div class="text-center mb-4">
      <img src="https://storage.googleapis.com/kidsworksheet.store/Logo/logo.png" alt="Logo" style="height:80px;">
      <h2 class="mt-3">Konfirmasi Pembelian</h2>
    </div>

    <div id="invoiceDetails"></div>
    <div id="statusMessage"></div>
    
    <div class="text-center mt-4">
      <a href="https://kidsworksheet.store" class="btn btn-primary">Kembali ke Beranda</a>
    </div>
  </div>

<script>
// === Variabel awal (dipertahankan) ===
const urlParams = new URLSearchParams(window.location.search);
let orderId = urlParams.get("order_id");
let status  = urlParams.get("status");

const nama          = localStorage.getItem("nama") || "(tidak tersedia)";
const email         = localStorage.getItem("email") || "(tidak tersedia)";
const total         = localStorage.getItem("total") || 0;
let modulDipilih    = JSON.parse(localStorage.getItem("modulDipilih") || "[]");

// [SECURE PATCH] Abaikan status dari URL agar tidak bisa dipalsukan
(() => {
  const urlStatus = (status || "").toLowerCase();
  if (urlStatus) {
    console.warn("‚ö†Ô∏è Mengabaikan parameter ?status= dari URL untuk keamanan.");
    status = "pending";
  }
})();

// [SYNC PATCH] Array downloadLinks dari webhook/email
let downloadLinks   = [];

// üß© Normalisasi nama modul agar cocok dengan file di GCS
function mapModulKeURL(modul) {
  const namaAsli = typeof modul === "string" ? modul : modul.nama;
  const cleanName = namaAsli.replace(/[:]/g, "").replace(/\s+/g, " ").trim();
  const encoded = encodeURIComponent(cleanName) + ".pdf";
  return `https://kidsworksheet.store/Modul/${encoded}`;
}

// [NEW PATCH] Fungsi ambil status transaksi langsung dari Cloud Function (API/check-status)
// üîß Sinkronisasi host Gen 2 yang aktif: midtransHandler (tanpa tanda minus)
async function getTransactionStatus(order_id) {
  try {
    const resp = await fetch(`https://midtranshandler-smbjamnkmq-et.a.run.app/check-status?order_id=${encodeURIComponent(order_id)}`);
    if (!resp.ok) throw new Error("HTTP " + resp.status);
    const data = await resp.json();
    console.log("üì¶ [CHECK-STATUS] Response:", data);
    if (data.transaction_status) {
      if (data.transaction_status === "settlement") status = "success";
      else if (data.transaction_status === "pending") status = "pending";
      else status = "failed";
    }
    return data;
  } catch (err) {
    console.error("‚ùå [CHECK-STATUS] gagal mengambil status:", err);
    return null;
  }
}

// === Render tabel modul (dipertahankan, disesuaikan sinkronisasi) ===
function renderRows() {
  if ((modulDipilih.length === 0) && downloadLinks.length > 0) {
    modulDipilih = downloadLinks.map(d => ({ nama: d.nama, url: d.url }));
  }

  if (modulDipilih.length === 0) {
    return `<tr><td colspan="3" class="text-center text-muted">Data modul tidak tersedia.</td></tr>`;
  }

  return modulDipilih.map((m, i) => {
    const nama = typeof m === "string" ? m : (m.nama || m.name);
    const secureUrl = (typeof m === "object" && m.url) ? m.url : null;
    const fallbackUrl = mapModulKeURL(nama);

    if (status === "success") {
      if (secureUrl) {
        return `
          <tr>
            <td>${i + 1}</td>
            <td>${nama}</td>
            <td><a href="${secureUrl}" target="_blank" class="btn-download">Unduh Modul</a></td>
          </tr>`;
      } else {
        return `
          <tr>
            <td>${i + 1}</td>
            <td>${nama}</td>
            <td><span class="btn-disabled">üîí Link akan dikirim via email</span></td>
          </tr>`;
      }
    } else {
      return `
        <tr>
          <td>${i + 1}</td>
          <td>${nama}</td>
          <td><span class="btn-disabled">‚è≥ Menunggu Pembayaran</span></td>
        </tr>`;
    }
  }).join("");
}

// === Render status (dipertahankan) ===
function renderStatus() {
  if (status === "success") {
    return `<div class="alert alert-success mt-3 text-center">
      ‚úÖ Pembayaran Anda <strong>BERHASIL</strong>.<br>
      Link unduhan tersedia di bawah (hanya jika telah diterbitkan link aman) dan juga telah dikirim ke email Anda.
    </div>`;
  } else if (status === "pending") {
    return `<div class="alert alert-warning mt-3 text-center">
      ‚è≥ Pembayaran Anda <strong>belum selesai</strong>.<br>
      Harap selesaikan pembayaran agar dapat mengunduh modul.
    </div>`;
  } else {
    return `<div class="alert alert-danger mt-3 text-center">
      ‚ùå Transaksi tidak ditemukan atau dibatalkan.<br>
      Silakan ulangi proses pembelian.
    </div>`;
  }
}

// === Logika utama (dipertahankan + verifikasi otomatis Midtrans) ===
async function initPage() {
  if (!orderId) {
    document.body.innerHTML = `
      <div class="container text-center mt-5">
        <h3 class="text-danger">‚ùå Halaman tidak valid</h3>
        <p>Nomor transaksi tidak ditemukan.</p>
        <a href="https://kidsworksheet.store" class="btn btn-primary mt-3">Kembali ke Beranda</a>
      </div>`;
    return;
  }

  // ‚úÖ Verifikasi status transaksi real-time dari Midtrans
  const trx = await getTransactionStatus(orderId);
  if (trx && trx.transaction_status === "settlement") {
    status = "success";
  }

  // [SYNC PATCH] load link unduh dari sessionStorage
  const linksFromSession = sessionStorage.getItem(`downloadLinks_${orderId}`);
  if (linksFromSession) {
    try { downloadLinks = JSON.parse(linksFromSession); } catch {}
  }

  // Render detail invoice
  document.getElementById("invoiceDetails").innerHTML = `
    <p><strong>Order ID:</strong> ${orderId}</p>
    <p><strong>Nama:</strong> ${nama}</p>
    <p><strong>Email:</strong> ${email}</p>
    <p><strong>Tanggal:</strong> ${new Date().toLocaleString("id-ID",{timeZone:"Asia/Jakarta",dateStyle:"long",timeStyle:"short"})}</p>
    <table class="table mt-3">
      <thead><tr><th>No</th><th>Modul</th><th>Link Download</th></tr></thead>
      <tbody>${renderRows()}</tbody>
    </table>
    <div class="text-end fw-bold fs-5 mt-3">Total: Rp${Number(total).toLocaleString("id-ID")}</div>
  `;

  // Render status akhir
  document.getElementById("statusMessage").innerHTML = renderStatus();

  // === [SYNC PATCH ‚Ä¢ PIXEL] Definisikan TOTAL_PEMBAYARAN & trigger Purchase hanya saat success ===
  // (Menjaga kompatibilitas potongan lama yang memanggil fbq di bawah)
  window.TOTAL_PEMBAYARAN = Number(total) || 0;
  try {
    if (status === "success" && typeof fbq !== "undefined") {
      fbq('track', 'Purchase', { value: window.TOTAL_PEMBAYARAN, currency: 'IDR' });
      console.log('üü¢ [META PIXEL] Purchase dikirim (guarded).');
    } else {
      console.log('‚ÑπÔ∏è [META PIXEL] Purchase tidak dikirim (status bukan success atau fbq belum tersedia).');
    }
  } catch (e) {
    console.warn('‚ö†Ô∏è [META PIXEL] Gagal mengirim Purchase (guarded):', e);
  }
}

// Jalankan saat halaman siap
document.addEventListener("DOMContentLoaded", initPage);


// === Potongan lama (DIPERTAHANKAN) ===
// Baris di bawah sebelumnya menyebabkan ReferenceError karena TOTAL_PEMBAYARAN belum didefinisikan
// dan event dikirim tanpa guard status. Kini sudah didefinisikan & dijaga di atas.
/*
  fbq('track', 'Purchase', {
    value: TOTAL_PEMBAYARAN, // misal 5000
    currency: 'IDR'
  });
*/
</script>

</script>
</body>
</html>
